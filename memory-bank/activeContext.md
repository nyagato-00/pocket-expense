# アクティブコンテキスト

## 現在の作業の焦点

現在、**ユーザー認証・認可機能**の実装に取り組んでいます。この機能は、アプリケーションのセキュリティの基盤となる重要な部分です。

### 実装状況

#### バックエンド

- ✅ **認証ユーティリティ**: パスワードのハッシュ化、トークン生成・検証などの基本機能
- ✅ **認証ミドルウェア**: リクエストの認証チェック、権限チェック
- ✅ **認証ルーター**: 登録、ログイン、トークンリフレッシュ、ログアウトのエンドポイント
- ✅ **tRPC設定**: 認証・認可を考慮したプロシージャの設定

#### フロントエンド

- ✅ **認証コンテキスト**: ユーザー状態、トークン管理、認証メソッドの提供
- ✅ **ログインページ**: ユーザーログイン用のUI
- ✅ **登録ページ**: 新規ユーザー登録用のUI
- ✅ **プロフィールページ**: ユーザー情報表示・編集用のUI
- ✅ **ダッシュボードページ**: ログイン後のメインページ
- ✅ **認証フロー**: 登録→ログイン→ダッシュボード→プロフィール→ログアウトの一連の流れ

#### テスト・ドキュメント

- ❌ **バックエンドテスト**: 認証関連のユニットテスト、統合テスト
- ❌ **フロントエンドテスト**: コンポーネントテスト、E2Eテスト
- ❌ **Storybook**: 認証関連UIコンポーネントのストーリー
- ❌ **ドキュメント**: 認証システムの設計・使用方法の説明

## 最近の変更

1. **データベーススキーマの更新**:
   - Userモデルに認証関連フィールド（passwordHash、salt、refreshToken）を追加
   - マイグレーションを実行して変更を適用

2. **認証ユーティリティの実装**:
   - bcryptjsを使用したパスワードハッシュ化
   - JWTを使用したトークン生成・検証

3. **認証ミドルウェアの実装**:
   - isAuthenticated: トークン検証
   - isAdmin: 管理者権限チェック
   - isApprover: 承認者権限チェック

4. **認証ルーターの実装**:
   - register: ユーザー登録
   - login: ログイン
   - refreshToken: トークンリフレッシュ
   - logout: ログアウト
   - me: 現在のユーザー情報取得

5. **認証コンテキストの実装**:
   - ユーザー状態管理
   - トークン管理（ローカルストレージ）
   - 認証メソッド（ログイン、登録、ログアウト）

## 次のステップ

1. **フロントエンドの機能拡張**:
   - 経費申請フォームの作成
   - 経費申請一覧の表示
   - 経費申請詳細の表示
   - 承認者向け機能の実装

2. **開発環境の改善**:
   - ✅ シードデータの実装（開発環境用）
   - テスト環境の整備
   - CI/CDパイプラインの設定

## 最近の変更

1. **認証機能の実装完了**:
   - ユーザー登録機能の実装と動作確認
   - ログイン機能の実装と動作確認
   - プロフィール編集機能の実装と動作確認
   - ログアウト機能の実装と動作確認

2. **Docker環境の活用**:
   - Docker Composeを使用した開発環境の構築
   - フロントエンド、バックエンド、データベースの連携
   - 環境変数の設定と管理

3. **APIエンドポイントの修正**:
   - tRPC APIのエンドポイントを`/api/trpc`に設定
   - フロントエンドのAPI接続設定を修正

2. **テストの実装**:
   - バックエンド: 認証ユーティリティ、ミドルウェア、ルーターのテスト
   - フロントエンド: 認証コンテキスト、認証UIコンポーネントのテスト

3. **Storybookの実装**:
   - 認証関連UIコンポーネントのストーリー作成
   - インタラクションテストの追加

4. **ドキュメントの作成**:
   - 認証システムの設計ドキュメント
   - APIドキュメント
   - ユーザーガイド

## 現在の課題

1. **セキュリティ強化**:
   - パスワードポリシーの実装
   - レート制限の実装
   - CSRF対策の検討

2. **UX改善**:
   - エラーメッセージの改善
   - フォームバリデーションの強化
   - ローディング状態の表示

3. **テスト環境の整備**:
   - テストデータベースの設定
   - モックの作成
   - CI/CDパイプラインの設定
